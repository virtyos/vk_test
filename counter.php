<?php  require_once('modules/AppModule.php');    require_once('models/SiteModel.php');  require_once('models/UserModel.php');  require_once('models/StatSiteModel.php');  require_once('models/StatUserModel.php');    $siteId = getRequestParam('siteId');  $site = null;  if ($siteId) {    $site = \SiteModel\select(array('conditions' => 'id = :id', 'params' => array(':id' => $siteId)));  }    //if it's no such site  if (!$site) {    throw new Exception('no such site');    die();  }  $site = $site[0];    //get user's data  $ip = $_SERVER['REMOTE_ADDR'];  $userAgent = $_SERVER['HTTP_USER_AGENT'];  $currentDay = date('Y-m-d');  $currentPage = $_SERVER['HTTP_REFERER'];    //get user model  $user = \UserModel\select(array('conditions'  => 'ip = :ip AND user_agent = :user_agent',     'params' => array(':ip' => $ip, ':user_agent' => $userAgent)));  if (!$user) {    //create the user if necessary    \UserModel\insert(array('ip' => $ip, 'user_agent' => $userAgent));    $user = \UserModel\select(array('conditions' => 'ip = :ip AND user_agent = :user_agent',       'params' => array(':ip' => $ip, ':user_agent' => $userAgent)));      }  $user = $user[0];    //default state - the user is not interested in the site  $isInterest = 0;  //flag - is new user or not;  $isNewUser = false;    //did the user visit this site today?  $currentDateUserStat = \StatUserModel\select(array(    'conditions' => 'id_user = :id_user AND date_visit = :date_visit',    'params' => array (      ':id_user' => $user['id'],      ':date_visit' => $currentDay,    )  ));    if (!$currentDateUserStat) {    //new user stats    \StatUserModel\insert(      array(        'id_user' => $user['id'],        'id_site' => $site['id'],        'date_visit' => $currentDay,        'count_visit' => 1,      )    );    //this user is new    $isNewUser = true;  } else {    $currentDateUserStat = $currentDateUserStat[0];    $lookedPages = json_decode($currentDateUserStat['site_pages']);    //if the "look_depth" is set for the site    // and the user was not marked as interested before today    if ($site['look_depth'] > 0 && !$currentDateUserStat['is_interest']) {      if (!in_array($currentPage, $lookedPages)) {        $lookedPages[] = $currentPage;      }      if (sizeof($lookedPages) >= $site['look_depth']) {        $isInterest = 1;      }    }    $lookedPages = json_encode($lookedPages);    //update user stats    \StatUserModel\update(array(      '#count_visit' => 'count_visit + 1',      'is_interest' => ($currentDateUserStat['is_interest'] > 0)?$currentDateUserStat['is_interest']:$isInterest,      'site_pages' => $lookedPages,      ),      'id = :id',      array(        ':id' => $currentDateUserStat['id'],      )    );  }    //get and update the site stats  $currentDateSiteStat = \StatSiteModel\select(array(    'conditions' => 'id_site = :id_site AND date_visit = :date_visit',    'params' => array(      ':id_site' => $site['id'],      ':date_visit' => $currentDay,    )  ));    if ($currentDateSiteStat) {    $currentDateSiteStat = $currentDateSiteStat[0];    $siteStatUpdateData = array();    if ($isNewUser) {      $siteStatUpdateData['#count_visit'] = 'count_visit + 1';    }    if ($isInterest) {      $siteStatUpdateData['#count_interest_visits']  = 'count_interest_visits + 1';    }    //if we have something to update    if (!empty($siteStatUpdateData)) {      \StatSiteModel\update($siteStatUpdateData,        'id = :id',        array(          ':id' => $currentDateSiteStat['id'],        )      );    }  } else {    \StatSiteModel\insert(      array(        'id_site' => $site['id'],        'date_visit' => $currentDay,        'count_visit' => 1,      )    );  }  